# Решение проблемы "Не корректный идентификатор чека" в Payme

## Проблема

Ошибка "Не корректный идентификатор чека" возникает, когда Payme не может проверить заказ через ваш эндпоинт `/payme/merchant`.

## Причины

1. **Эндпоинт недоступен из интернета** - Payme не может достучаться до `localhost:8000`
2. **Неправильный URL в настройках Payme** - в личном кабинете указан неверный URL
3. **Проблемы с CORS или сетью** - запросы блокируются

## Решение

### Вариант 1: Использование ngrok (для тестирования)

1. **Установите ngrok:**
```bash
# macOS
brew install ngrok

# Или скачайте с https://ngrok.com/download
```

2. **Запустите ngrok:**
```bash
ngrok http 8000
```

3. **Скопируйте полученный URL:**
```
Forwarding: https://abc123.ngrok.io -> http://localhost:8000
```

4. **Настройте в личном кабинете Payme:**
   - Зайдите в https://payme.uz
   - Перейдите в настройки кассы
   - Укажите URL эндпоинта: `https://abc123.ngrok.io/payme/merchant`
   - Сохраните настройки

5. **Перезапустите бэкенд** (если нужно)

### Вариант 2: Использование реального сервера

Если у вас есть сервер с публичным IP:

1. Разместите бэкенд на сервере
2. Укажите URL в настройках Payme: `https://your-domain.com/payme/merchant`
3. Убедитесь, что сервер доступен из интернета

### Вариант 3: Проверка настроек

1. **Проверьте merchant_id:**
   - Убедитесь, что используете правильный `merchant_id` из личного кабинета
   - Проверьте, что касса активирована

2. **Проверьте URL эндпоинта:**
   - В личном кабинете Payme должен быть указан правильный URL
   - URL должен быть доступен из интернета (не localhost)

3. **Проверьте логи бэкенда:**
```bash
tail -f /tmp/backend.log
```
   - При попытке оплаты должны появляться запросы от Payme

## Тестирование эндпоинта

Проверьте, что эндпоинт работает:

```bash
curl -X POST http://localhost:8000/payme/merchant \
  -H "Content-Type: application/json" \
  -d '{
    "method": "CheckPerformTransaction",
    "params": {
      "amount": 100000,
      "account": {
        "order_id": "1"
      }
    }
  }'
```

Должен вернуться ответ:
```json
{
  "result": {
    "allow": true,
    "detail": {...}
  }
}
```

## Важно

- Для работы Payme эндпоинт `/payme/merchant` **должен быть доступен из интернета**
- `localhost` не работает - нужен публичный URL
- Используйте ngrok для локальной разработки
- В продакшене используйте реальный домен с HTTPS

